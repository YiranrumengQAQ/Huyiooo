<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å›¾è™«çµæ„Ÿæ°”æ³¡ç”»å»Š</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --green: #22c55e;
      --green-soft: #bbf7d0;
      --green-dark: #15803d;
      --bg: #e5f7ee;
      --bubble: #f9fffb;
      --text-main: #064e3b;
      --text-sub: #6b7280;
      --shadow-soft: 0 18px 40px rgba(15, 118, 110, 0.18);
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
      background: radial-gradient(circle at top left, #bbf7d0 0, transparent 55%),
                  radial-gradient(circle at bottom right, #a5f3fc 0, transparent 55%),
                  linear-gradient(135deg, #ecfdf3, #e0f2fe);
      min-height: 100vh;
      padding: 18px 10px;
      color: var(--text-main);
    }
    .app {
      max-width: 1240px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 32px;
      box-shadow: 0 22px 60px rgba(22, 101, 52, 0.32);
      padding: 16px 16px 18px;
      position: relative;
      overflow: hidden;
    }
    .app::before {
      content: '';
      position: absolute;
      width: 340px; height: 340px;
      border-radius: 999px;
      background: radial-gradient(circle, rgba(34, 197, 94, 0.32), transparent 70%);
      top: -160px; right: -80px;
      pointer-events: none;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 14px;
      position: relative;
      z-index: 1;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .brand-logo {
      width: 42px; height: 42px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fefce8 0, #22c55e 35%, #16a34a 60%, #15803d 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 16px 35px rgba(22, 163, 74, 0.6);
    }
    .brand-logo span {
      font-weight: 800;
      font-size: 20px;
      color: #ecfdf3;
      text-shadow: 0 3px 8px rgba(21, 128, 61, 0.9);
    }
    .brand-text h1 {
      font-size: 19px;
      margin-bottom: 2px;
    }
    .brand-text p {
      font-size: 11px;
      color: var(--text-sub);
    }
    .actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-end;
    }
    .search-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: rgba(236, 253, 245, 0.9);
      border-radius: 999px;
      border: 1px solid rgba(34, 197, 94, 0.4);
      box-shadow: 0 10px 22px rgba(22, 101, 52, 0.25);
    }
    .search-bar input {
      border: none;
      outline: none;
      background: transparent;
      font-size: 12px;
      color: var(--text-main);
      min-width: 140px;
    }
    .search-bar input::placeholder {
      color: #9ca3af;
    }
    .search-tag-btn {
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      background: white;
      color: var(--green-dark);
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(22, 163, 74, 0.32);
      transition: transform 0.18s ease, box-shadow 0.18s ease;
    }
    .search-tag-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 28px rgba(22, 163, 74, 0.46);
    }
    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: flex-end;
    }
    .pill-filter {
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(240, 253, 244, 0.95);
      font-size: 10px;
      color: var(--text-sub);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .pill-filter.active {
      background: var(--green);
      color: white;
      border-color: transparent;
      box-shadow: 0 8px 20px rgba(22, 163, 74, 0.5);
    }

    .layout {
      display: grid;
      grid-template-columns: 3fr 1.4fr;
      gap: 14px;
    }
    .bubble-panel {
      background: var(--bubble);
      border-radius: 26px;
      padding: 11px 12px 12px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.35);
      position: relative;
      overflow: hidden;
    }
    .bubble-panel::before {
      content: '';
      position: absolute;
      width: 160px; height: 160px;
      border-radius: 999px;
      background: radial-gradient(circle, rgba(187, 247, 208, 0.7), transparent 70%);
      top: -80px; left: -40px;
      opacity: 0.75;
      pointer-events: none;
    }
    .bubble-header {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .bubble-header h2 {
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .bubble-header h2 span.icon {
      width: 22px; height: 22px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #bbf7d0 0, #22c55e 45%, #16a34a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #ecfdf5;
      box-shadow: 0 9px 18px rgba(21, 128, 61, 0.6);
    }
    .bubble-sub {
      font-size: 11px;
      color: var(--text-sub);
    }

    .gallery {
      position: relative;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
      gap: 10px;
      max-height: 520px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .gallery::-webkit-scrollbar,
    .side-scroll::-webkit-scrollbar {
      width: 6px;
    }
    .gallery::-webkit-scrollbar-thumb,
    .side-scroll::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #86efac, #22c55e);
      border-radius: 999px;
    }

    .card {
      position: relative;
      border-radius: 24px;
      overflow: hidden;
      background: #ecfdf3;
      box-shadow: 0 14px 36px rgba(22, 101, 52, 0.45);
      cursor: pointer;
      transform-origin: center;
      animation: float-in 0.6s ease both;
      transition: transform 0.22s ease, box-shadow 0.22s ease, translate 0.22s ease;
    }
    .card:hover {
      transform: translateY(-6px) scale(1.01);
      box-shadow: 0 20px 48px rgba(22, 101, 52, 0.75);
    }
    .card-image-wrap {
      position: relative;
      overflow: hidden;
      border-radius: 22px;
      margin: 6px 6px 0;
    }
    .card-image {
      width: 100%; height: 180px;
      object-fit: cover;
      display: block;
      transition: transform 0.6s ease;
      background: #022c22;
    }
    .card:hover .card-image {
      transform: scale(1.06);
    }
    .image-top-bar {
      position: absolute;
      top: 8px; left: 8px; right: 8px;
      display: flex;
      justify-content: space-between;
      pointer-events: none;
    }
    .bubble-label {
      backdrop-filter: blur(12px);
      background: rgba(15, 118, 110, 0.7);
      color: #ecfdf5;
      font-size: 10px;
      padding: 3px 7px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      box-shadow: 0 8px 16px rgba(15, 118, 110, 0.7);
    }
    .image-bottom-bar {
      position: absolute;
      left: 8px; right: 8px; bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      pointer-events: none;
    }
    .stats-pill {
      backdrop-filter: blur(16px);
      background: rgba(15, 23, 42, 0.7);
      color: #f9fafb;
      font-size: 11px;
      padding: 4px 9px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.7);
    }
    .download-btn-small {
      pointer-events: auto;
      border: none;
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 10px;
      background: #f9fafb;
      color: var(--green-dark);
      display: inline-flex;
      align-items: center;
      gap: 3px;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(22, 163, 74, 0.65);
    }

    .card-body {
      padding: 8px 10px 9px;
    }
    .card-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      color: #052e16;
    }
    .tag-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 7px;
    }
    .tag {
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      background: rgba(22, 163, 74, 0.07);
      color: var(--green-dark);
      border: 1px solid rgba(22, 163, 74, 0.32);
    }
    .meta-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .author {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .author-avatar {
      width: 24px; height: 24px;
      border-radius: 999px;
      object-fit: cover;
      border: 1px solid rgba(34, 197, 94, 0.8);
      box-shadow: 0 0 0 2px #ecfdf3;
    }
    .author-text {
      font-size: 10px;
    }
    .author-name {
      font-weight: 600;
    }
    .author-sub {
      color: var(--text-sub);
    }
    .meta-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .meta-chip {
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      background: #ecfdf3;
      color: var(--text-sub);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .download-main-btn {
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      background: var(--green);
      color: #ecfdf3;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      box-shadow: 0 10px 22px rgba(34, 197, 94, 0.7);
    }

    .loading {
      font-size: 12px;
      color: var(--text-sub);
      padding: 10px 0;
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
    }
    .spinner {
      width: 18px; height: 18px;
      border-radius: 999px;
      border: 2px solid rgba(148, 163, 184, 0.8);
      border-top-color: var(--green);
      animation: spin 0.85s linear infinite;
    }
    .error {
      margin-top: 6px;
      padding: 6px 9px;
      border-radius: 14px;
      background: #fee2e2;
      color: #b91c1c;
      font-size: 11px;
      display: none;
    }
    .load-more-wrap {
      margin-top: 6px;
      display: flex;
      justify-content: center;
    }
    .load-more {
      border: none;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 11px;
      background: #bbf7d0;
      color: var(--green-dark);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      box-shadow: 0 12px 28px rgba(22, 163, 74, 0.55);
      transition: transform 0.18s ease, box-shadow 0.18s ease;
    }
    .load-more:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 34px rgba(21, 128, 61, 0.7);
    }
    .load-more:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }

    .side-scroll {
      max-height: 520px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .side-card {
      background: #ecfdf3;
      border-radius: 24px;
      padding: 10px 11px 11px;
      box-shadow: 0 12px 28px rgba(22, 101, 52, 0.3);
      border: 1px solid rgba(22, 163, 74, 0.3);
    }
    .side-title {
      font-size: 13px;
      margin-bottom: 6px;
    }
    .quick-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }
    .quick-tag {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #f0fdf4;
      border: 1px solid rgba(22, 163, 74, 0.4);
      color: var(--green-dark);
      cursor: pointer;
    }
    .hint {
      font-size: 10px;
      color: var(--text-sub);
      margin-bottom: 8px;
    }
    .mode-row {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
    }
    .mode-btn {
      flex: 1;
      border-radius: 999px;
      border: none;
      padding: 6px 0;
      font-size: 11px;
      background: #f0fdf4;
      color: var(--text-sub);
      cursor: pointer;
    }
    .mode-btn.active {
      background: var(--green);
      color: white;
      box-shadow: 0 10px 22px rgba(22, 163, 74, 0.7);
    }
    .switch-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 11px;
    }
    .switch {
      position: relative;
      width: 38px; height: 20px;
      border-radius: 999px;
      background: #d1fae5;
      cursor: pointer;
    }
    .switch-circle {
      position: absolute;
      top: 2px; left: 2px;
      width: 16px; height: 16px;
      border-radius: 999px;
      background: white;
      box-shadow: 0 4px 10px rgba(22, 163, 74, 0.55);
      transition: transform 0.2s ease;
    }
    .switch.on {
      background: #22c55e;
    }
    .switch.on .switch-circle {
      transform: translateX(18px);
    }
    .side-note {
      padding: 6px 7px;
      border-radius: 14px;
      background: #f0fdf4;
      font-size: 10px;
      color: var(--text-sub);
    }

    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes float-in {
      from { opacity: 0; transform: translateY(18px) scale(0.97); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }

    @media (max-width: 960px) {
      .layout { grid-template-columns: 1fr; }
      header { flex-direction: column; align-items: flex-start; }
      .actions { align-items: stretch; }
    }
    @media (max-width: 640px) {
      body { padding: 12px 6px; }
      .app { border-radius: 22px; padding: 12px 10px 14px; }
      .gallery { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand">
      <div class="brand-logo"><span>TC</span></div>
      <div class="brand-text">
        <h1>å›¾è™«çµæ„Ÿæ°”æ³¡ç”»å»Š</h1>
        <p>æœç´¢ã€ç­›é€‰ã€æ”¶è—å’Œä¸‹è½½çµæ„Ÿå›¾ç‰‡çš„è½»ç›ˆç©ºé—´</p>
      </div>
    </div>
    <div class="actions">
      <div class="search-bar">
        <input id="searchInput" type="text" placeholder="æŒ‰æ ‡é¢˜æˆ–æ ‡ç­¾æœç´¢ï¼Œä¾‹å¦‚ï¼šé£å…‰ / äººåƒ" />
        <button class="search-tag-btn" id="searchBtn" type="button">ğŸ” æœç´¢</button>
      </div>
      <div class="filter-row">
        <button class="pill-filter active" data-filter="all" type="button">å…¨éƒ¨</button>
        <button class="pill-filter" data-filter="popular" type="button">é«˜çƒ­åº¦</button>
        <button class="pill-filter" data-filter="latest" type="button">æœ€æ–°</button>
        <button class="pill-filter" data-filter="fav" type="button">æˆ‘å–œæ¬¢</button>
      </div>
    </div>
  </header>

  <div class="layout">
    <section class="bubble-panel">
      <div class="bubble-header">
        <div>
          <h2><span class="icon">ğŸŒ±</span>çµæ„Ÿå›¾ç‰‡æµ</h2>
          <p class="bubble-sub">æ»šåŠ¨æµè§ˆï¼Œæˆ–é€šè¿‡ä¸Šæ–¹æœç´¢æ¡†å¿«é€Ÿå®šä½ä½ æƒ³è¦çš„é£æ ¼</p>
        </div>
      </div>
      <div id="loading" class="loading">
        <span class="spinner"></span>
        <span>æ­£åœ¨è·å–çµæ„Ÿå›¾ç‰‡ï¼Œè¯·ç¨å€™â€¦</span>
      </div>
      <div id="error" class="error"></div>
      <div id="gallery" class="gallery"></div>
      <div class="load-more-wrap">
        <button id="loadMore" class="load-more" style="display:none;" type="button">
          <span>åŠ è½½æ›´å¤šå›¾ç‰‡</span>
          <span>â†“</span>
        </button>
      </div>
    </section>

    <aside class="bubble-panel">
      <div class="side-scroll">
        <div class="side-card">
          <h3 class="side-title">å°åŠ©æ‰‹ Â· å¿«é€Ÿæ“ä½œ</h3>
          <p class="hint">è¯•è¯•ç‚¹å‡»ä¸‹é¢çš„æ ‡ç­¾ï¼Œå¿«é€Ÿç­›å‡ºå¯¹åº”é£æ ¼çš„æ¨èå›¾ç‰‡ã€‚</p>
          <div class="quick-tags">
            <button class="quick-tag" data-tag="é£å…‰" type="button"># é£å…‰</button>
            <button class="quick-tag" data-tag="äººåƒ" type="button"># äººåƒ</button>
            <button class="quick-tag" data-tag="è¡—æ‹" type="button"># è¡—æ‹</button>
            <button class="quick-tag" data-tag="æ—…è¡Œ" type="button"># æ—…è¡Œ</button>
            <button class="quick-tag" data-tag="é»‘ç™½" type="button"># é»‘ç™½</button>
            <button class="quick-tag" data-tag="åŸå¸‚" type="button"># åŸå¸‚</button>
          </div>
          <div class="mode-row">
            <button class="mode-btn active" id="modeRecommend" type="button">æ¨èæ¨¡å¼</button>
            <button class="mode-btn" id="modeExplore" type="button">æ¢ç´¢æ¨¡å¼</button>
          </div>
          <div class="switch-row">
            <span>ä¼˜å…ˆæ˜¾ç¤ºé«˜èµå›¾ç‰‡</span>
            <div class="switch on" id="switchPopular"><div class="switch-circle"></div></div>
          </div>
          <div class="switch-row">
            <span>ä»…å±•ç¤ºæœ‰æ ‡ç­¾çš„ä½œå“</span>
            <div class="switch" id="switchHasTag"><div class="switch-circle"></div></div>
          </div>
          <div class="side-note">
            æç¤ºï¼šç‚¹å‡»å›¾ç‰‡å¡ç‰‡å¯ä»¥æ‰“å¼€åŸé¡µé¢è¯¦æƒ…ï¼›ç‚¹å‡»ä¸‹è½½æŒ‰é’®å¯ä»¥ä¿å­˜å½“å‰é¢„è§ˆå›¾ï¼ˆå…·ä½“æ¸…æ™°åº¦å–å†³äºæ¥å£è¿”å›çš„å›¾ç‰‡å°ºå¯¸ï¼‰ã€‚
          </div>
        </div>
      </div>
    </aside>
  </div>
</div>

<script>
  const API_URL = 'https://api.tuchong.com/feed-app';
  let lastPostId = null;
  let isLoading = false;
  let allItems = [];
  let likedIds = new Set();

  const gallery = document.getElementById('gallery');
  const loadingDiv = document.getElementById('loading');
  const errorDiv = document.getElementById('error');
  const loadMoreBtn = document.getElementById('loadMore');
  const searchInput = document.getElementById('searchInput');
  const searchBtn = document.getElementById('searchBtn');

  const filterButtons = document.querySelectorAll('.pill-filter');
  let currentFilter = 'all';

  const switchPopular = document.getElementById('switchPopular');
  const switchHasTag = document.getElementById('switchHasTag');
  let onlyPopular = true;
  let onlyHasTag = false;

  const modeRecommend = document.getElementById('modeRecommend');
  const modeExplore = document.getElementById('modeExplore');
  let mode = 'recommend';

  async function fetchImages() {
    if (isLoading) return;
    isLoading = true;
    loadingDiv.style.display = 'flex';
    loadMoreBtn.disabled = true;
    errorDiv.style.display = 'none';

    try {
      const url = lastPostId ? `${API_URL}?post_id=${lastPostId}` : API_URL;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`HTTP: ${resp.status}`);
      const data = await resp.json();
      if (Array.isArray(data.feedList) && data.feedList.length > 0) {
        const newItems = data.feedList.filter(i => i.type !== 'post' || i.images);
        allItems = allItems.concat(newItems);
        lastPostId = data.feedList[data.feedList.length - 1].post_id;
        applyAndRender();
        loadMoreBtn.style.display = 'inline-flex';
      } else {
        showError('å·²ç»æ²¡æœ‰æ›´å¤šå›¾ç‰‡äº†');
      }
    } catch (e) {
      showError('åŠ è½½å¤±è´¥ï¼š' + e.message);
    } finally {
      isLoading = false;
      loadingDiv.style.display = 'none';
      loadMoreBtn.disabled = false;
    }
  }

  function applyAndRender() {
    const keyword = searchInput.value.trim().toLowerCase();
    let items = allItems.slice();

    if (onlyHasTag) {
      items = items.filter(i => Array.isArray(i.tags) && i.tags.length > 0);
    }
    if (keyword) {
      items = items.filter(i => {
        const title = (i.title || '').toLowerCase();
        const tags = Array.isArray(i.tags) ? i.tags.join(' ').toLowerCase() : '';
        return title.includes(keyword) || tags.includes(keyword);
      });
    }
    if (currentFilter === 'popular' || onlyPopular) {
      items.sort((a, b) => (b.favorites || 0) - (a.favorites || 0));
    } else if (currentFilter === 'latest') {
      items.sort((a, b) => {
        const da = new Date(a.published_at || 0).getTime();
        const db = new Date(b.published_at || 0).getTime();
        return db - da;
      });
    } else if (currentFilter === 'fav') {
      items = items.filter(i => likedIds.has(i.post_id));
    }
    if (mode === 'explore') {
      items.sort(() => Math.random() - 0.5);
    }
    renderGallery(items);
  }

  function renderGallery(list) {
    gallery.innerHTML = '';
    list.forEach((item, index) => {
      if (!item.images || item.images.length === 0) return;
      const image = item.images[0];
      const userId = image.user_id || (item.site && item.site.site_id) || '';
      const imgId = image.img_id;
      const imageUrl = (userId && imgId) ? `https://photo.tuchong.com/${userId}/f/${imgId}.jpg` : '';

      const site = item.site || {};
      const tags = Array.isArray(item.tags) ? item.tags : [];
      const liked = likedIds.has(item.post_id);

      const card = document.createElement('article');
      card.className = 'card';
      card.style.animationDelay = (index * 40) + 'ms';

      card.addEventListener('click', e => {
        if (e.target.closest('button')) return;
        if (item.url) window.open(item.url, '_blank');
      });

      const tagHtml = tags.length
        ? `<div class="tag-row">${tags.slice(0, 3).map(t => `<span class="tag">#${t}</span>`).join('')}</div>`
        : '';

      const title = item.title || 'æ— æ ‡é¢˜ä½œå“';
      const publishedText = item.published_at ? new Date(item.published_at).toLocaleDateString() : 'æ—¶é—´æœªçŸ¥';

      card.innerHTML = `
        <div class="card-image-wrap">
          <img class="card-image" src="${imageUrl}" alt="${title}" loading="lazy"
               onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27360%27 height=%27180%27%3E%3Crect width=%27360%27 height=%27180%27 fill=%27%23022c22%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 fill=%27%23a7f3d0%27 font-size=%2714%27 text-anchor=%27middle%27 dominant-baseline=%27middle%27%3Eå›¾ç‰‡åŠ è½½å¤±è´¥%3C/text%3E%3C/svg%3E'">
          <div class="image-top-bar">
            <div class="bubble-label">${tags[0] ? `# ${tags[0]}` : 'çµæ„Ÿå›¾ç‰‡'}</div>
          </div>
          <div class="image-bottom-bar">
            <div class="stats-pill">
              <span>â¤ ${formatNumber(item.favorites || 0)}</span>
              <span>ğŸ’¬ ${formatNumber(item.comments || 0)}</span>
            </div>
            <button class="download-btn-small" type="button">â¬‡ ä¸‹è½½</button>
          </div>
        </div>
        <div class="card-body">
          <h2 class="card-title">${title}</h2>
          ${tagHtml}
          <div class="meta-row">
            <div class="author">
              <img class="author-avatar" src="${site.icon || ''}" alt="${site.name || 'ä½œè€…'}"
                   onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2724%27 height=%2724%27%3E%3Ccircle cx=%2712%27 cy=%2712%27 r=%2712%27 fill=%27%23145a32%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 fill=%27%23bbf7d0%27 font-size=%2710%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27%3Eå›¾%3C/text%3E%3C/svg%3E'">
              <div class="author-text">
                <div class="author-name">${site.name || 'åŒ¿åä½œè€…'}</div>
                <div class="author-sub">${publishedText}</div>
              </div>
            </div>
            <div class="meta-actions">
              <button class="meta-chip like-btn" type="button">${liked ? 'â˜… å·²å–œæ¬¢' : 'â˜† å–œæ¬¢'}</button>
              <button class="download-main-btn" type="button">â¬‡ ä¿å­˜</button>
            </div>
          </div>
        </div>
      `;

      const smallDownload = card.querySelector('.download-btn-small');
      const mainDownload = card.querySelector('.download-main-btn');
      const likeBtn = card.querySelector('.like-btn');

      const doDownload = () => {
        if (!imageUrl) return;
        const a = document.createElement('a');
        a.href = imageUrl;
        a.download = `tuchong_${imgId || 'image'}.jpg`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      };

      smallDownload.addEventListener('click', e => { e.stopPropagation(); doDownload(); });
      mainDownload.addEventListener('click', e => { e.stopPropagation(); doDownload(); });

      likeBtn.addEventListener('click', e => {
        e.stopPropagation();
        if (likedIds.has(item.post_id)) {
          likedIds.delete(item.post_id);
        } else {
          likedIds.add(item.post_id);
        }
        applyAndRender();
      });

      gallery.appendChild(card);
    });
  }

  function formatNumber(num) {
    if (num >= 10000) return (num / 10000).toFixed(1) + 'w';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
    return num.toString();
  }

  function showError(msg) {
    errorDiv.textContent = msg;
    errorDiv.style.display = 'block';
  }

  searchBtn.addEventListener('click', () => applyAndRender());
  searchInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') applyAndRender();
  });

  filterButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      filterButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentFilter = btn.getAttribute('data-filter') || 'all';
      applyAndRender();
    });
  });

  switchPopular.addEventListener('click', () => {
    onlyPopular = !onlyPopular;
    switchPopular.classList.toggle('on', onlyPopular);
    applyAndRender();
  });
  switchHasTag.addEventListener('click', () => {
    onlyHasTag = !onlyHasTag;
    switchHasTag.classList.toggle('on', onlyHasTag);
    applyAndRender();
  });

  modeRecommend.addEventListener('click', () => {
    mode = 'recommend';
    modeRecommend.classList.add('active');
    modeExplore.classList.remove('active');
    applyAndRender();
  });
  modeExplore.addEventListener('click', () => {
    mode = 'explore';
    modeExplore.classList.add('active');
    modeRecommend.classList.remove('active');
    applyAndRender();
  });

  document.querySelectorAll('.quick-tag').forEach(btn => {
    btn.addEventListener('click', () => {
      const tag = btn.getAttribute('data-tag') || '';
      searchInput.value = tag;
      applyAndRender();
    });
  });

  loadMoreBtn.addEventListener('click', fetchImages);
  fetchImages();
</script>
</body>
</html>
